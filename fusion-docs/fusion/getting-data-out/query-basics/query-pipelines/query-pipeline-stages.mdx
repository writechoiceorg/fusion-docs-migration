---
title: "Query Pipeline Stages"
permalink: "169"
---

import {InlineImage} from "/snippets/InlineImage.mdx";

A query pipeline is made up of a series of query stages that process incoming search queries.

A pipeline stage definition associates a unique ID with a set of properties.
These definitions are registered with the Fusion API service and stored in ZooKeeper for re-use across pipelines and search applications.

Fusion includes a number of specialized query stages as well as a JavaScript stage that allows advanced processing via a JavaScript program.

<Tip>
The [Query Pipeline Stages Reference](/fusion/5.9/278/query-pipeline-stages-reference) section contains articles that detail the configuration for each of the Fusion query pipeline stages. The configuration information includes field names and values, as well as examples and other key reference information.
</Tip>



## Configuring query pipeline stages

* In the Fusion UI, the [Query Workbench](/fusion/5.9/167/query-workbench) provides an environment for configuring the stages in a query pipeline.
* The [Query Stages API](/fusion/5.9/362/query-stages-api) is used to create, list, update, or delete query stages using JSON. See also the [Query Pipelines API](/fusion/5.9/360/query-pipelines-api).

### Pipeline stage JSON editor

The pipeline stage JSON editor gives the ability to create and copy pipeline stages by pasting JSON objects in the Fusion UI. Only JSON is supported, and JSON validation is included to prevent the user from saving an invalid object.

Navigate to your pipelines, select a pipeline stage, and click the **JSON View** button to open the editor:

<Frame>![JSON View button](/assets/images/5.2/pipeline-stage-json-edit.png)</Frame>

Existing stages are considered **READ-ONLY**. They will have only a copy button which can be used to create stages. New stages will have the option to copy or paste valid JSON. Changes are applied to the stage with the **Apply** button.

<Note>
Users will still need to **Save** the stage for the changes made in the editor to be saved.
</Note>

The editor has several elements worth noting:

| Elements | Description |
| --- | --- |
| <InlineImage src="/assets/images/5.2/json-editor/copy.png"/> | Copies the JSON to the clipboard. |
| <InlineImage src="/assets/images/5.2/json-editor/paste.png"/> | Pastes the clipboard into the editor. Only valid JSON is accepted. |
| <InlineImage src="/assets/images/5.2/json-editor/expand.png"/> | Expands the editor to a fullscreen view. |
| <InlineImage src="/assets/images/5.2/json-editor/condense.png"/> | Condenses the editor to a compact view. |
| <InlineImage src="/assets/images/5.2/json-editor/apply.png"/> | Applies the JSON in the editor and updates the stage. The stage must be saved to preserve the changes. |
| <InlineImage src="/assets/images/5.2/json-editor/reset.png"/> | Resets changes made since the last time changes were applied. |

For instructions, see [Use the Pipeline Stage JSON Editor](/how-to/3294/use-the-pipeline-stage-json-editor).

## JavaScript selector

Now your pipeline definitions can include your choice of JavaScript engine, either Nashorn or OpenJDK Nashorn.
While Nashorn is the default option, it is in the process of being deprecated and will eventually be removed, so it is recommended to use OpenJDK Nashorn when possible.
You can select the JavaScript engine in the pipeline views or in the workbenches.
Your JavaScript pipeline stages are interpreted by the selected engine.

<Frame>![JavaScript engine selector](/assets/images/5.9/5.9.6/js-engine-selector.png)</Frame>

## Asynchronous query pipeline processing

Query pipeline processing performance can be improved by enabling asynchronous processing for certain stages that make requests to secondary collections, external databases, and so on. The following stages support asynchronous processing:

* [Active Directory Security Trimming](/fusion/5.9/296/active-directory-security-trimming-stage)
* [Apply Rules](/fusion/5.9/535/apply-rules-stage)
* [JDBC Lookup](/fusion/5.9/260/jdbc-lookup-stage)
* [Security Trimming](/fusion/5.9/272/security-trimming-stage)
* [Solr Subquery](/fusion/5.9/297/solr-subquery-stage)

This feature uses the fork-and-join model, where any of the stages above can create a fork on the pipeline. The parallel processes are joined again using the [Merge Async Results stage](/fusion/5.9/266/merge-async-results-stage) at a later point in the pipeline.

## Conditional query processing

Query Pipeline stages are used to modify Request objects
and Response objects. Each stage can include a conditional JavaScript expression (the `condition` property in its configuration) that can access these objects.

For example, this condition first checks that the property `fusion-user-name` is specified in the Request object, then checks for a particular value:

```js
request.hasParam("fusion-user-name") && request.getFirstParam("fusion-user-name").equals("SuperUser");
```

## Additional resources

<Note>
**LucidAcademy**

Lucidworks offers free training to help you get started.

The **Quick Learning** for **Top 3 Query Pipeline Stages** focuses on useful querying stages:

<Frame>
  <a href="https://academy.lucidworks.com/top-3-query-pipeline-stages" target="_blank">
    <div class="note-image-wrapper">
      <img noZoom src="/assets/images/training-covers/query-pipeline-stages.png" alt="Top 3 Query Pipeline Stages" class="note-image" />
      <img noZoom src="/images/play-btn.svg" alt="Play Button" class="note-image-overlay" />
    </div>
  </a>
</Frame>


Visit the [LucidAcademy](https://academy.lucidworks.com) to see the full training catalog.
</Note>
