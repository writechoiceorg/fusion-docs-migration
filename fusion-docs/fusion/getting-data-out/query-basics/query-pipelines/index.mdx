---
title: "Query Pipelines"
permalink: "173"
---

A Query Pipeline transforms a set of inputs into a Solr query request and it can execute requests and manipulate the Solr response as well, via a set of modularized operations called [Query Stages](/fusion/5.9/278/query-pipeline-stages). The objects sent from stage to stage are Request objects and Response objects.

Fusion stores pipeline names and definitions, allowing a pipeline to be reused across applications. Pipeline definitions can be modified, so that as an application evolves, the pipelines used by that application can evolve accordingly. During application development, the Fusion UI can be used to develop and debug a Query Pipeline.

The available stage types allow setting specific parameters for the query, such as the number of results to return or the query parser to use. You can also define facets and recommendations to be returned with the results. If Access Control Lists (ACLs) are in use, you can apply a security-trimming stage to apply user access restrictions to the results.

For details about the available REST APIs, see [Query Pipelines API](/fusion/5.9/360/query-pipelines-api) and [Query Stages API](/fusion/5.9/362/query-stages-api).

## Search mode

When creating a query pipeline, you can select a search mode for the pipeline to use.

* `dsl` ([Domain Specific Language](/fusion/5.9/8833/domain-specific-language-dsl)) uses expressive search queries and responses via a structured, modern JSON format.
* `legacy` primarily uses Solr parameters. See the [Solr Query Language cheat sheet](/fusion/5.9/199/solr-query-language-cheat-sheet).
* `all` uses both DSL and legacy search modes. This is the default value.

<Note>
The default value of `all` works well for most use cases.
</Note>

## Default query pipelines

Fusion creates a default query pipeline when you create an app. The query pipeline has the same name as the app.

The default query pipeline has the following pre-configured stages:

* [Text Tagger](/fusion/5.9/520/text-tagger-stage)

  This stage uses the [SolrTextTagger](/solr-reference-guide/10252/the-tagger-handler) handler to identify known entities in the query by searching the [`COLLECTION_NAME_query_rewrite` collection](/fusion/5.9/8831/collections#auxiliary-collections). See [Manage Collections in the Fusion UI](/how-to/812/manage-collections-in-the-fusion-ui) for more information.

<Note>
For Fusion 5.x.x organizations that do *not* have a Predictive Merchandiser license, the Solr Text Tagger handler also searches the `COLLECTION_NAME_query_rewrite_staging` collection in the case of the Fusion query rewriting [Simulator](/fusion-ai/4.2/484/simulator).
</Note>

* [Boost with Signals](/fusion/5.9/511/boost-with-signals-stage)

  The Boost with Signals query pipeline stage uses [aggregated signals](/fusion/5.9/aclc1h/aggregations) to selectively boost items in the set of search results.
* [Query Fields](/fusion/5.9/289/query-fields-stage)

  The Query Fields query pipeline stage defines common Solr query parameters for the [edismax query parser](https://cwiki.apache.org/confluence/display/solr/The+Extended+DisMax+Query+Parser). If using a less-than sign (\<) with DisMax, it must be escaped using a backslash.
  An alternative to this stage is the
  [Additional Query Parameters stage](/fusion/5.9/294/additional-query-parameters-stage).
* [Field Facet](/fusion/5.9/252/field-facet-stage)

  The Field Facet query pipeline stage is used to add a
  [Solr Field Facet query](https://cwiki.apache.org/confluence/display/solr/Faceting#Faceting-Field-ValueFacetingParameters)
  to the search query pipeline.
* [Apply Rules](/fusion/5.9/535/apply-rules-stage)

  This stage looks up rules that have been deployed to the [`COLLECTION_NAME_query_rewrite` collection](/fusion/5.9/489/query-rewriting#collections) and matches them against the query. Matching rules that perform [query rewriting](/fusion/5.9/489/query-rewriting) are applied at this stage, while matching rules that perform [response rewriting](/fusion/5.9/449/response-rewriting) are applied by the [Modify Response with Rules](/fusion/5.9/537/modify-response-with-rules-stage) stage later in the pipeline.

<Note>
To trigger a rule that contains a tag, specify the tagname in the request URL of the user search app. See [Easily define triggers in tags](/fusion/5.9/8838/general-configurations#tags) for more information.
</Note>

* A [Solr Query](/fusion/5.9/265/solr-query-stage)

  The Solr Query stage transforms the Fusion query pipeline
  [Request](/fusion-pipeline-javadocs/5.9/com/lucidworks/apollo/pipeline/query/request)
  object into a Solr query and sends it to Solr.
* [Modify Response with Rules](/fusion/5.9/537/modify-response-with-rules-stage)

  Most rules operate on the request, but some [rule types](/fusion/5.9/489/query-rewriting#types), such as banner rules or redirect rules, do their work when the response comes back. The Modify Response with Rules stage applies those rules to the response. For example, a banner rule can add a banner URL to the response before returning it to the client.

## Custom query pipelines

Using the [Query Workbench](/fusion/5.9/167/query-workbench) or the [REST API](/fusion/5.9/360/query-pipelines-api), you can develop custom pipelines to suit any search application. Start with any of Fusionâ€™s built-in query pipelines, then add, remove, and re-order the [pipeline stages](/fusion/5.9/278/query-pipeline-stages) as needed to produce the appropriate query results.

## Asynchronous query pipeline processing

Query pipeline processing performance can be improved by enabling asynchronous processing for certain stages that make requests to secondary collections, external databases, and so on. The following stages support asynchronous processing:

* [Active Directory Security Trimming](/fusion/5.9/296/active-directory-security-trimming-stage)
* [Apply Rules](/fusion/5.9/535/apply-rules-stage)
* [JDBC Lookup](/fusion/5.9/260/jdbc-lookup-stage)
* [Security Trimming](/fusion/5.9/272/security-trimming-stage)
* [Solr Subquery](/fusion/5.9/297/solr-subquery-stage)

This feature uses the fork-and-join model, where any of the stages above can create a fork on the pipeline. The parallel processes are joined again using the [Merge Async Results stage](/fusion/5.9/266/merge-async-results-stage) at a later point in the pipeline.