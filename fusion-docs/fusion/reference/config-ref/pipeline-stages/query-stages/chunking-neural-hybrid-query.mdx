---
title: "Chunking Neural Hybrid Query Stage"
permalink: "4klbo6"
---

The Chunking Neural Hybrid Query stage performs hybrid lexical-semantic search that combines BM25-type lexical search with KNN dense vector search via Solr. This stage differs from the [Neural Hybrid Stage](/fusion/5.9/mb500k/neural-hybrid-query-stage) because it supports chunking.

Not sure which hybrid query stage is right for you? Read about the
[differences between the hybrid query stages](/fusion/5.9/fhx9nk/differences-between-hybrid-query-stages).

<Note>
This feature is only available in Fusion 5.9.x for versions 5.9.12 and later.
</Note>

Click **Get Started** below to see how to enable chunking in Fusion:

{/* <iframe src="https://app.supademo.com/embed/cmbjyucmh00j9xu0j0vmhkoum?embed_v=2" loading="lazy" title="Enable chunking in Fusion" allow="clipboard-write" frameborder="0" webkitallowfullscreen="true" mozallowfullscreen="true" allowfullscreen="" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></iframe> */}

## About the Lexical Query Squash Factor

The **Lexical Query Squash Factor** field lets you input a value that squashes the lexical query scores from `0..inf` to `0..1`.
This setting helps prevent the lexical query from dominating the final score, and normalizes the score into a range that works well with vector similarity scores.
Additionally, it helps prevent the [vanishing gradient problem](https://en.wikipedia.org/wiki/Vanishing_gradient_problem), which occurs when very high lexical scores are mapped to values extremely close to `1`, such as `0.99999999`.
During the hybrid search calculation, these near-1 values can cause the system to lose sensitivity to subtle differences in lexical relevance, effectively 'squashing' the gradient and reducing the impact of lexical scoring.

Lucidworks recommends setting the **Lexical Query Squash Factor** to the inverse of the maximum lexical score observed across your queries.
This helps balance the impact of lexical and vector scores, leading to more accurate and nuanced search results.

## Prefiltering

Prefiltering is a technique that can improve performance and accuracy by filtering documents before applying the algorithm, reducing the number of documents that need to be processed.
This is especially effective with the KNN algorithm.

Prefiltering is disabled by default.
To enable it, uncheck **Block pre-filtering** in this stage.

When prefiltering is enabled, you can configure the filters using one or both of these methods:

* Security filters

  You can use security filters as prefilters by placing the [Graph Security Trimming Stage](/fusion/5.9/zdzlfu/graph-security-trimming-stage) *after* this one in the pipeline.
  Then Fusion uses the security trimming filter as a prefilter.
* JavaScript

  When prefiltering is enabled, this stage adds a `preFilterKey` object to the Javascript `ctx` object.
  You can place a [Javascript stage](/fusion/5.9/283/java-script-query-stage) after this one and use it to access the `preFilterKey` object, as in this example:

  ```js
  if(ctx.hasProperty("preFilterKey")) {
    var preFilter = ctx.getProperty("preFilterKey");
    preFilter.addFilter(filterQuery)
  }
  ```

## Query pipeline stage condition examples

Stages can be triggered conditionally when a script in the **Condition** field evaluates to true.
Some examples are shown below.

Run this stage only for mobile clients:

```js
params.deviceType === "mobile"
```

Run this stage when debugging is enabled:

```js
params.debug === "true"
```

Run this stage when the query includes a specific term:

```js
params.q && params.q.includes("sale")
```

Run this stage when multiple conditions are met:

```js
request.hasParam("fusion-user-name") && request.getFirstParam("fusion-user-name").equals("SuperUser");
!request.hasParam("isFusionPluginQuery")
```

The first condition checks that the request parameter "fusion-user-name" is present and has the value "SuperUser".
The second condition checks that the request parameter "isFusionPluginQuery" is not present.

## Configuration

<Tip>
When entering configuration values in the UI, use *unescaped* characters, such as `\t` for the tab character. When entering configuration values in the API, use *escaped* characters, such as `\\t` for the tab character.
</Tip>



import {SchemaParamFields} from "/snippets/SchemaParamFields.mdx";
import {schema} from "/snippets/configuration-schema/5_9/query-stages/chunking-neural-hybrid-query.mdx";

<SchemaParamFields schema={schema}/>
