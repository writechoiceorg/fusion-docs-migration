---
title: "Custom JavaScript Stages Global Variables"
permalink: "395"
---

## JavaScript Index Stage Global Variables

[JavaScript](http://en.wikipedia.org/wiki/JavaScript) is a lightweight scripting language.
In a JavaScript stage, Fusion uses the Nashorn engine, which implements [ECMAScript](http://en.wikipedia.org/wiki/ECMAScript) version 5.1.

What a JavaScript program can do depends on the container in which it runs.
For a JavaScript Index stage, the container is a Fusion index pipeline.
The following global pipeline variables are available:

| Name | Type | Description |
| --- | --- | --- |
| `doc` | [PipelineDocument](/fusion-pipeline-javadocs/5.9/com/lucidworks/apollo/common/pipeline/pipelinedocument) | The contents of each document submitted to the pipeline. |
| `ctx` | [Context](/fusion-pipeline-javadocs/5.9/com/lucidworks/apollo/pipeline/context) | A map that stores miscellaneous data created by each stage of the pipeline. <br/> <Tip> **Important**<br/> Use the `ctx` variable instead of the deprecated `_context` global variable. </Tip><br/> The `ctx` variable is used to: <br/>● Pass data from one stage to another<br/>● Store data that needs to be passed from one custom stage to a later custom stage  The data can differ between stages: <br/>● If the previous stage changes the data<br/>● Based on the configuration of each stage <br/><Note> If the data is modified in one stage, it may cause a later stage to function irregularly. </Note> |
| `collection` | String | The name of the Fusion collection being indexed or queried. |
| `solrServer` | [BufferingsolrServer](/fusion-pipeline-javadocs/5.9/com/lucidworks/apollo/component/bufferingsolrserver) | The Solr server instance that manages the pipeline’s default Fusion collection. All indexing and query requests are done by calls to methods on this object. See [solrClient](https://lucene.apache.org/solr/5_2_1/solr-solrj/org/apache/solr/client/solrj/SolrClient.html) for details |
| `solrServerFactory` | [solrClusterComponent](/fusion-pipeline-javadocs/5.9/com/lucidworks/cloud/api/solr/solrclustercomponent) | The SolrCluster server used for lookups by collection name which returns a Solr server instance for that collection. For example:  `var productsSolr = solrServerFactory.getSolrServer("products");`. |

### Syntax Variants

JavaScript stages can be written using ***function syntax***. With function syntax, global variables are passed as function parameters.

<Note>
Support for legacy syntax was removed in Fusion 5.8.
</Note>

#### Function Syntax

Function syntax is used for moderately complex tasks.

```js
function (doc) {
    // do some work ...
    return doc;
}
```

<Tip>
**Important**


*Function syntax* is used for the examples in this document.
</Tip>



#### Advanced Syntax

Advanced syntax is used for complex tasks and when multiple functions are needed.

```js
/* globals Java, logger*/
(function () {
    "use strict";

    return function main(doc , ctx, collection, solrServer, solrServerFactory) {
    // do some work ...

        return doc;
    };
})();
```

### JavaScript Use

The JavaScript in a JavaScript Index stage must return either a single document or an array of documents.
This can be accomplished by either:

* a series of statements where the final statement evaluates to a document or array of documents
* a function that returns a document or an array of documents

All pipeline variables referenced in the body of the JavaScript function are passed in as arguments to the function. For example, in order to access the PipelineDocument in global variable 'doc',
the JavaScript function is written as follows:

```js
function (doc) {
    // do some work ...
    return doc;
}
```

The allowed set of function declarations are:

```js
function doWork(doc) {  ... return doc; }
function doWork(doc, ctx) {  ... return doc; }
function doWork(doc, ctx, collection) {  ... return doc; }
function doWork(doc, ctx, collection, solrServer) {  ... return doc; }
function doWork(doc, ctx, collection, solrServer, SolrClusterComponent) {  ... return doc; }
```

The order of these arguments is according to the (estimated) frequency of use.
The assumption is that most processing only requires access to the document object itself,
and the next-most frequent type of processing requires only the document and read-only access of some context parameters.
If you need to reference the solrServerFactory global variable, you must use the 5-arg function declaration.

In order to use other functions in your JavaScript program, you can define and use them, as long as the final statement
in the program returns a document or documents.

### Global variable `logger`

The logs are output to the indexing service logs for custom index stages. Access the Log Viewer and filter on this service to view the information.

## JavaScript Query Stage Global Variables

[JavaScript](http://en.wikipedia.org/wiki/JavaScript) is a lightweight scripting language.
In a JavaScript stage, Fusion uses the Nashorn engine, which implements [ECMAScript](http://en.wikipedia.org/wiki/ECMAScript) version 5.1.

What a JavaScript program can do depends on the container in which it runs.
For a JavaScript Query stage, the container is a Fusion query pipeline.
The following global pipeline variables are available:

| Name | Type | Description |
| --- | --- | --- |
| `request` | [Request for a Regular Query](/fusion-pipeline-javadocs/5.9/com/lucidworks/apollo/pipeline/query/request) | The `request` variable contains Solr query information and is referred to as a **regular** request. A regular query request does *not* include Search DSL (domain specific language) parameters. |
| `request` | [DSL Request](/fusion-pipeline-javadocs/5.9/com/lucidworks/search/dsl/request/dslrequest) | The `request` variable is also used when the query contains parameters for a Search DSL (domain specific language) request. <br/><Note> See [Domain Specific Language](/fusion/5.9/8833/domain-specific-language-dsl) for more information. </Note>|
| `response` | [Response for a Regular Query](/fusion-pipeline-javadocs/5.9/com/lucidworks/apollo/pipeline/query/response) | The `response` variable contains Solr response information, and is used to return information from a **regular** request. Because a regular request does *not* include Search DSL (domain specific language) parameters, the response will not return Search DSL results. |
| `response` | [DSL Response](/fusion-pipeline-javadocs/5.9/com/lucidworks/search/dsl/response/dslresponse) | The `response` variable is also used to return information from a Search DSL (domain specific language) request. <br/><Note> See [Domain Specific Language](/fusion/5.9/8833/domain-specific-language-dsl) for more information. </Note>|
| `ctx` | [Context](/fusion-pipeline-javadocs/5.9/com/lucidworks/apollo/pipeline/context) | A map that stores miscellaneous data created by each stage of the pipeline. <br/><Tip> **Important**<br/> Use the `ctx` variable instead of the deprecated `_context` global variable. </Tip> The `ctx` variable is used to: <br/>● Pass data from one stage to another<br/>● Store data that needs to be passed from one custom stage to a later custom stage  The data can differ between stages: <br/>● If the previous stage changes the data<br/>● Based on the configuration of each stage <br/><Note> If the data is modified in one stage, it may cause a later stage to function irregularly. </Note> |
| `collection` | String | The name of the Fusion collection being indexed or queried. |
| `solrServer` | [BufferingsolrServer](/fusion-pipeline-javadocs/5.9/com/lucidworks/apollo/component/bufferingsolrserver) | The Solr server instance that manages the pipeline’s default Fusion collection. All indexing and query requests are done by calls to methods on this object. See [solrClient](https://lucene.apache.org/solr/5_2_1/solr-solrj/org/apache/solr/client/solrj/SolrClient.html) for details. |
| `solrServerFactory` | [solrClusterComponent](/fusion-pipeline-javadocs/5.9/com/lucidworks/cloud/api/solr/solrclustercomponent) | The SolrCluster server used for lookups by collection name which returns a Solr server instance for that collection, e.g.  `var productsSolr = solrServerFactory.getSolrServer("products");`. |
| `QueryRequestAndResponse` | [QueryRequestAndResponse](/fusion-pipeline-javadocs/5.9/com/lucidworks/apollo/pipeline/query/queryrequestandresponse) | Used to create query pipeline requests and responses. |
| `JSONResponse` | [JSONResponse](/fusion-pipeline-javadocs/5.9/com/lucidworks/apollo/solr/response/jsonresponse) | Returns list of info as a string. |

<Note>
See [Custom JavaScript Query Stage Examples](/fusion/5.9/864/custom-java-script-query-stage-examples) for more information.
</Note>

### Syntax Variants

JavaScript stages can be written using ***function syntax***. With function syntax, global variables are passed as function parameters.

<Note>
Support for legacy syntax was removed in Fusion 5.8.
</Note>

#### Function Syntax

```js
function(request,response) {
    request.addParam("foo", "bar");
}
```

<Tip>
**Important**


*Function syntax* is used for the examples in this document.
</Tip>

### Global variable `logger`

The logs are output to the query service logs for custom query stages. Access the Log Viewer and filter on this service to view the information.