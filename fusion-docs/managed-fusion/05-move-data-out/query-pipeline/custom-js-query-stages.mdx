---
title: "Custom JavaScript stages for query pipelines"
permalink: "4k288e"
---

The JavaScript Query stage allows you to write custom processing logic using JavaScript
to manipulate search requests and responses.
The first time that the pipeline is run, Managed Fusion compiles the JavaScript program
into Java bytecode using the JDK’s JavaScript engine.

The JavaScript Query stage allows you to run JavaScript functions over search requests and responses by manipulating variables called "request" and "response" which are
[Request objects](/fusion-pipeline-javadocs/5.9/com/lucidworks/apollo/pipeline/query/request)
and
[Response objects](/fusion-pipeline-javadocs/5.9/com/lucidworks/apollo/pipeline/query/response), respectively.

<Warning>
Users who can create or modify code obtain access to the broader Managed Fusion environment. This access can be used to create intentional or unintentional damage to Managed Fusion.
</Warning>

## The JavaScript engine used by Managed Fusion

The default JavaScript engine used by Managed Fusion is the Nashorn engine from Oracle.
See [The Nashorn Java API](https://docs.oracle.com/javase/8/docs/technotes/guides/scripting/nashorn/api.html) for details.

In Managed Fusion 5.9.6 and up, you also have the option to select OpenJDK Nashorn.
While Nashorn is the default option, it is in the process of being deprecated and will eventually be removed, so it is recommended to use OpenJDK Nashorn when possible.
You can select the JavaScript engine in the pipeline views or in the workbenches.
Your JavaScript pipeline stages are interpreted by the selected engine.

<Frame>![JavaScript engine selector](/assets/images/5.9/5.9.6/js-engine-selector.png)</Frame>

## JavaScript Query Stage global variables

[JavaScript](http://en.wikipedia.org/wiki/JavaScript) is a lightweight scripting language.
In a JavaScript stage, Fusion uses the Nashorn engine, which implements [ECMAScript](http://en.wikipedia.org/wiki/ECMAScript) version 5.1. Although Nashorn does include some ECMAScript 6 (ES6) features such as `let`, `const`, or template strings, Fusion does not enable ES6 by default, so ES6 support is not guaranteed.

What a JavaScript program can do depends on the container in which it runs.
For a JavaScript Query stage, the container is a Managed Fusion query pipeline.
The following global pipeline variables are available:

| Name | Type | Description |
| --- | --- | --- |
| `request` | [Request for a Regular Query](/fusion-pipeline-javadocs/5.9/com/lucidworks/apollo/pipeline/query/request) | The `request` variable contains Solr query information and is referred to as a **regular** request. A regular query request does *not* include Search DSL (domain specific language) parameters. |
| `request` | [DSL Request](/fusion-pipeline-javadocs/5.9/com/lucidworks/search/dsl/request/dslrequest) | The `request` variable is also used when the query contains parameters for a Search DSL (domain specific language) request.  <Note> See [Domain Specific Language](/managed-fusion/5.9/0bvcy0/domain-specific-language-dsl) for more information. </Note> |
| `response` | [Response for a Regular Query](/fusion-pipeline-javadocs/5.9/com/lucidworks/apollo/pipeline/query/response) | The `response` variable contains Solr response information, and is used to return information from a **regular** request. Because a regular request does *not* include Search DSL (domain specific language) parameters, the response will not return Search DSL results. |
| `response` | [DSL Response](/fusion-pipeline-javadocs/5.9/com/lucidworks/search/dsl/response/dslresponse) | The `response` variable is also used to return information from a Search DSL (domain specific language) request.  <Note> See [Domain Specific Language](/managed-fusion/5.9/0bvcy0/domain-specific-language-dsl) for more information. </Note> |
| `ctx` | [Context](/fusion-pipeline-javadocs/5.9/com/lucidworks/apollo/pipeline/context) | A map that stores miscellaneous data created by each stage of the pipeline.  <Note> Use the `ctx` variable instead of the deprecated `_context` global variable. </Note> The `ctx` variable is used to:  * Pass data from one stage to another * Store data that needs to be passed from one custom stage to a later custom stage  The data can differ between stages:  * If the previous stage changes the data * Based on the configuration of each stage <Note> If the data is modified in one stage, it may cause a later stage to function irregularly. </Note> |
| `collection` | String | The name of the Managed Fusion collection being indexed or queried. |
| `solrServer` | [BufferingsolrServer](/fusion-pipeline-javadocs/5.9/com/lucidworks/apollo/component/bufferingsolrserver) | The Solr server instance that manages the pipeline’s default Managed Fusion collection. All indexing and query requests are done by calls to methods on this object. See [solrClient](https://lucene.apache.org/solr/5_2_1/solr-solrj/org/apache/solr/client/solrj/SolrClient.html) for details. |
| `solrServerFactory` | [solrClusterComponent](/fusion-pipeline-javadocs/5.9/com/lucidworks/cloud/api/solr/solrclustercomponent) | The SolrCluster server used for lookups by collection name which returns a Solr server instance for that collection, e.g.  `var productsSolr = solrServerFactory.getSolrServer("products");`. |
| `QueryRequestAndResponse` | [QueryRequestAndResponse](/fusion-pipeline-javadocs/5.9/com/lucidworks/apollo/pipeline/query/queryrequestandresponse) | Used to create query pipeline requests and responses. |
| `JSONResponse` | [JSONResponse](/fusion-pipeline-javadocs/5.9/com/lucidworks/apollo/solr/response/jsonresponse) | Returns list of info as a string. |

<Note>
See [Custom JavaScript Query Stage examples](/fusion/5.9/864/custom-java-script-query-stage-examples) for more information.
</Note>

### Syntax variants

JavaScript stages can be written using ***legacy syntax*** or ***function syntax***. The key difference between these syntax variants is how the "global variables" are used and interpreted. While using legacy syntax, these variables are used as global variables. With function syntax, however, these variables are passed as function parameters.

#### Legacy syntax

```js
request.addParam("foo", "bar");
```

#### Function syntax

```js
function(request,response) {
   request.addParam("foo", "bar");
}
```

<Note>
**Important**

*Function syntax* is used for the examples in this document.
</Note>

### Global variable `logger`

The logs are output to the query service logs for custom query stages. Access the Log Viewer and filter on this service to view the information.

## See also

* [Managed Fusion Pipeline Javadocs](/fusion-pipeline-javadocs/5.9/)
* [JavaScript Query Stage](/managed-fusion/5.9/56khq2/java-script-query-stage)
* [Custom JavaScript Query Stage examples](/fusion/5.9/864/custom-java-script-query-stage-examples)
* [Custom JavaScript Stages global variables](/fusion/5.9/395/custom-java-script-stages-global-variables)
* [Managed JavaScript Query Stage](/managed-fusion/5.9/zfwfyr/managed-java-script-query-stage)

<Note>
**LucidAcademy**

Lucidworks offers free training to help you get started.

The **Course** for **JavaScript in Fusion** focuses on how to leverage JavaScript in Fusion to build powerful and responsive scripts at index and query time:

<Frame>
  <a href="https://academy.lucidworks.com/javascript-in-fusion" target="_blank">
    <div class="note-image-wrapper">
      <img noZoom src="/assets/images/training-covers/javascript-in-fusion.jpg" alt="JavaScript in Fusion" class="note-image" />
      <img noZoom src="/images/play-btn.svg" alt="Play Button" class="note-image-overlay" />
    </div>
  </a>
</Frame>


Visit the [LucidAcademy](https://academy.lucidworks.com) to see the full training catalog.

</Note>